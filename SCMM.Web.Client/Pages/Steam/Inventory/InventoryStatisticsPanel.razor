@using SCMM.Web.Data.Models.Domain.InventoryItems
@inject ILogger<InventoryStatisticsPanel> Logger
@inject HttpClient Http
@inject AppState State

@if (InventoryPerformance == null)
{
    @if (LoadingError != null)
    {
        <Alert Exception="@LoadingError" />
    }
    else
    {
        <Loading Message="Loading inventory statistics..." />
    }
}
else
{
    <MudGrid Spacing="2" Class="ma-4">
        @if(InventoryPerformanceValueHistoryChart != null)
        {
            <MudItem xs="12" xl="6">
                <ChartJsLineChart @ref="InventoryPerformanceValueHistoryChartJs" Config="@InventoryPerformanceValueHistoryChart" />
            </MudItem>
        }
        @if(InventoryPerformanceValueChart != null)
        {
            <MudItem xs="12" xl="6">
                <ChartJsPieChart @ref="InventoryPerformanceValueChartJs" Config="@InventoryPerformanceValueChart" />
            </MudItem>
        }
    </MudGrid>
}

@code {
    
    [Parameter]
    public string SteamId { get; set; }
    
    [Parameter]
    public ProfileInventoryTotalsDTO InventoryTotals { get; set; }

    private ProfileInventoryPerformanceDTO InventoryPerformance { get; set; }

    private ChartJsPieChart InventoryPerformanceValueChartJs;
    private PieConfig InventoryPerformanceValueChart;

    private ChartJsLineChart InventoryPerformanceValueHistoryChartJs;
    private LineConfig InventoryPerformanceValueHistoryChart;
    
    private Exception LoadingError { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadInventoryPerformance();

        if (InventoryTotals != null)
        {
            RedrawInventoryPerformanceValueChart();
        }
        if (InventoryPerformance != null)
        {
            RedrawInventoryPerformanceValueHistoryChart();
        }
    }
    
    private async Task LoadInventoryPerformance()
    {
        try
        {
            Logger.LogInformation("Fetching inventory performance...");
            InventoryPerformance = await Http.GetFromJsonAsync<ProfileInventoryPerformanceDTO>(
                $"api/profile/{SteamId}/inventory/performance"
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error fetching inventory performance for '{SteamId}'");
            InventoryPerformance = null;
            LoadingError = ex;
            throw;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void RedrawInventoryPerformanceValueChart()
    {
        InventoryPerformanceValueChart = new PieConfig
        {
            Options = new PieOptions
            {
                Legend = new Legend
                {
                    Display = true,
                    Labels = new LegendLabelConfiguration()
                    {
                        FontColor = "#ffffff"
                    }
                },
                Responsive = true,
                Animation = new ArcAnimation
                {
                    AnimateRotate = true,
                    AnimateScale = true
                },
                Tooltips = new Tooltips
                {
                    Enabled = true
                }
            }
        };

        InventoryPerformanceValueChart.Data.Labels.AddRange(new[] {
            "Invested",
            "Resell Fees",
            "Resell Profit",
            "Resell Value"
        });

        var localScaleString = String.Empty.PadRight(State.Currency.Scale, '0');
        var localScaleDivisor = Int64.Parse($"1{localScaleString}");
        if (InventoryTotals != null)
        {
            var inventoryValueDataSet = new PieDataset
            {
                BackgroundColor = new[] {
                    "#d32f2f",
                    "#f57c00",
                    "#388e3c",
                    "#1976d2"
                },
                BorderWidth = 0
            };

            inventoryValueDataSet.Data.AddRange(new double[] {
                (DoubleWrapper)0,
                (DoubleWrapper)0,
                (DoubleWrapper)0,
                (DoubleWrapper)Math.Round((double)InventoryTotals.TotalResellValue / localScaleDivisor, State.Currency.Scale)
            });

            var inventoryValueBreakdownDataSet = new PieDataset
            {
                BackgroundColor = new[] {
                    "#d32f2f",
                    "#f57c00",
                    "#388e3c",
                    "#1976d2"
                },
                BorderWidth = 0
            };

            inventoryValueBreakdownDataSet.Data.AddRange(new double[] {
                (DoubleWrapper)Math.Round((double)(InventoryTotals.TotalInvested ?? 0) / localScaleDivisor, State.Currency.Scale),
                (DoubleWrapper)Math.Round((double)InventoryTotals.TotalResellTax / localScaleDivisor, State.Currency.Scale),
                (DoubleWrapper)Math.Round((double)InventoryTotals.TotalResellProfit / localScaleDivisor, State.Currency.Scale),
                (DoubleWrapper)0
            });

            InventoryPerformanceValueChart.Data.Datasets.Add(inventoryValueDataSet);
            InventoryPerformanceValueChart.Data.Datasets.Add(inventoryValueBreakdownDataSet);
        }
    }

    private void RedrawInventoryPerformanceValueHistoryChart()
    {
        InventoryPerformanceValueHistoryChart = new LineConfig
        {
            Options = new LineOptions
            {
                Legend = new Legend
                {
                    Display = true,
                    Labels = new LegendLabelConfiguration()
                    {
                        FontColor = "#ffffff"
                    }
                },
                Responsive = true,
                Tooltips = new Tooltips
                {
                    Enabled = true
                },
                Scales = new Scales
                {

                    xAxes = new List<CartesianAxis>
                    {
                        new CategoryAxis
                        {
                            Ticks = new CategoryTicks()
                            {
                                Display = true,
                                FontColor = "#ffffff"
                            },
                            ScaleLabel = new ScaleLabel()
                            {
                                Display = true,
                                FontColor = "#ffffff"
                            },
                            GridLines = new GridLines
                            {
                                Display = true,
                                Color = "#e0e0e0"
                            }
                        }
                    },
                    yAxes = new List<CartesianAxis>
                    {
                        new LinearCartesianAxis
                        {
                            Ticks = new LinearCartesianTicks()
                            {
                                Display = true,
                                FontColor = "#ffffff",
                                BeginAtZero = true
                            },
                            ScaleLabel = new ScaleLabel()
                            {
                                Display = true,
                                FontColor = "#ffffff"
                            },
                            GridLines = new GridLines
                            {
                                Display = true,
                                Color = "#e0e0e0"
                            }
                        }
                    }
                }
            }
        };

        if (InventoryPerformance != null)
        {
            InventoryPerformanceValueHistoryChart.Data.Labels = InventoryPerformance.ValueHistoryGraph.Keys.ToList();
        }

        var localScaleString = String.Empty.PadRight(State.Currency.Scale, '0');
        var localScaleDivisor = Int64.Parse($"1{localScaleString}");

        if (InventoryPerformance?.ProfitHistoryGraph != null && InventoryTotals?.TotalResellProfit > 0)
        {
            var profitHistoryDataSet = new LineDataset<DoubleWrapper>
            {
                Label = "Resell Profit",
                BackgroundColor = "#388e3c",
                BorderColor = "#1b5e20",
                BorderWidth = 1,
                PointBorderWidth = 2,
                PointRadius = 8,
                LineTension = 0.1,
                Fill = true
            };
            profitHistoryDataSet.AddRange(
                InventoryPerformance.ProfitHistoryGraph.Values.Select(x => (DoubleWrapper)Math.Round((double)x / localScaleDivisor, State.Currency.Scale)).ToList()
            );

            InventoryPerformanceValueHistoryChart.Data.Datasets.Add(profitHistoryDataSet);
        }

        if (InventoryPerformance?.ValueHistoryGraph != null)
        {
            var valueHistoryDataSet = new LineDataset<DoubleWrapper>
            {
                Label = "Market Value",
                BackgroundColor = "#1976d2",
                BorderColor = "#0d47a1",
                BorderWidth = 1,
                PointBorderWidth = 2,
                PointRadius = 8,
                LineTension = 0.1,
                Fill = true
            };
            valueHistoryDataSet.AddRange(
                InventoryPerformance.ValueHistoryGraph.Values.Select(x => (DoubleWrapper)Math.Round((double)x / localScaleDivisor, State.Currency.Scale)).ToList()
            );

            InventoryPerformanceValueHistoryChart.Data.Datasets.Add(valueHistoryDataSet);
        }
    }

}