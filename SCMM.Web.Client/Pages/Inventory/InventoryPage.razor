@using SCMM.Web.Data.Models.UI.Profile.Inventory
@page "/inventory/{SteamId}"
@page "/steam/inventory/{SteamId}"
@inherits PersistentComponent
@inject ILogger<InventoryPage> Logger
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ExternalNavigationManager ExternalNavigationManager
@inject HttpClient Http
@inject AppState State

<PageContainer Title="@(Profile != null ? $"Inventory - {Profile.Name}" : "Inventory")">
    <MudGrid Spacing="2">
        <InventoryHeaderPanel Profile="@Profile" InventoryTotal="@InventoryTotals" SynchroniseInventory="@OnSynchroniseInventory" />
        @if (Profile != null && InventoryTotals != null)
        {
            <MudHidden Breakpoint="Breakpoint.MdAndDown" Invert="true">
                <MudItem xs="12" sm="6" lg="4" xl="2" Class="d-flex flex-row justify-start align-center">
                    <MudTextField T="string" Value="@Filter" ValueChanged="@OnSearch" DebounceInterval="500" Placeholder="Filter items..." FullWidth="true" Class="ma-0" Disabled="State.IsPrerendering"
                                  Adornment="Adornment.Start" AdornmentIcon="fas fa-fw fa-filter mr-2" IconSize="MudBlazor.Size.Small" Variant="MudBlazor.Variant.Outlined" />
                </MudItem>
		    </MudHidden>
        }
        <MudItem xs="12">
            @if (Profile == null || InventoryTotals == null)
            {
                @if (LoadingError != null)
                {
                    if (LoadingErrorStatusCode == HttpStatusCode.NotFound && Profile == null)
                    {
                        <Alert Title="Steam profile not found" SubTitle="Check that the SteamID is correct, then try again." />
                    }
                    else if (LoadingErrorStatusCode == HttpStatusCode.NotFound && InventoryTotals == null)
                    {
                        <Alert Title="Steam inventory is currently private" SubTitle="We are unable to show you the contents of this inventory." Severity="Severity.Warning" />
                    }
                    else
                    {
                        <Alert Exception="@LoadingError" />
                    }
                }
                else
                {
                    <Loading Message="@LoadingMessage" />
                }
            }
            else
            {
                <MudTabs Elevation="0" ActivePanelIndex="PanelIndex" ActivePanelIndexChanged="OnSelectedPanelChanged" Class="mud-tabs-transparent">
                    <ChildContent>
                        <MudTabPanel Icon="fas fa-fw fa-th mr-2" Text="Inventory" Disabled="State.IsPrerendering">
                            <MudPaper Outlined="true">
                                <InventoryItemsPanel SteamId="@Profile?.SteamId" Filter="@Filter" />
                            </MudPaper>
                        </MudTabPanel>
                        <MudTabPanel Icon="fas fa-fw fa-tshirt mr-2" Text="Collections" Disabled="State.IsPrerendering">
                            <MudPaper Outlined="true">
                                <InventoryCollectionsPanel SteamId="@Profile?.SteamId" Filter="@Filter" />
                            </MudPaper>
                        </MudTabPanel>
                        <MudTabPanel Icon="fas fa-fw fa-balance-scale-left mr-4" Text="Movement" Disabled="State.IsPrerendering">
                            <MudPaper Outlined="true">
                                <InventoryMarketPanel SteamId="@Profile?.SteamId" Filter="@Filter" InventoryTotals="@InventoryTotals" />
                            </MudPaper>
                        </MudTabPanel>
                        <MudTabPanel Icon="fas fa-fw fa-hand-holding-usd mr-3" Text="Returns" Disabled="@((!State.Is(Profile?.SteamId) && !State.IsInRole(Roles.Administrator)) || State.IsPrerendering)">
                            <MudPaper Outlined="true">
                                <InventoryInvestmentPanel SteamId="@Profile?.SteamId" Filter="@Filter" />
                            </MudPaper>
                        </MudTabPanel>
                        <MudTabPanel Icon="fas fa-fw fa-chart-pie mr-2" Text="Statistics" Disabled="State.IsPrerendering">
                            <MudPaper Outlined="true">
                                <InventoryStatisticsPanel SteamId="@Profile?.SteamId" Filter="@Filter" InventoryTotals="@InventoryTotals" />
                            </MudPaper>
                        </MudTabPanel>
					</ChildContent>
	                <Header>
                        <MudHidden Breakpoint="Breakpoint.LgAndUp" Invert="true">
                            <MudTextField T="string" Value="@Filter" ValueChanged="@OnSearch" DebounceInterval="500" Placeholder="Search items..." FullWidth="true" Class="mt-0 mr-1"
                                          Adornment="Adornment.Start" AdornmentIcon="fas fa-fw fa-filter mr-2" IconSize="MudBlazor.Size.Small" Disabled="State.IsPrerendering" />
					    </MudHidden>
	                </Header>
                </MudTabs>
            }
        </MudItem>
    </MudGrid>
</PageContainer>

@code {

    [Parameter]
    public string SteamId { get; set; }
    
    [Parameter]
    [SupplyParameterFromQuery]
    public string Filter { get; set; }
    
    [Parameter]
    [SupplyParameterFromQuery]
    public string Panel { get; set; }

    private ProfileDetailedDTO Profile;

    private ProfileInventoryTotalsDTO InventoryTotals;
    
    private int PanelIndex;
    
    private string LoadingMessage;

    private Exception LoadingError;
    
    private HttpStatusCode? LoadingErrorStatusCode => (LoadingError as HttpRequestException)?.StatusCode;
    
    protected override void OnInitialized()
    {
        switch (Panel)
        {
            case "items": PanelIndex = 0; break;
            case "collections": PanelIndex = 1; break;
            case "market": PanelIndex = 2; break;
            case "investment": PanelIndex = 3; break;
            case "statistics": PanelIndex = 4; break;
        }
    }
    
    protected override async Task OnLoadStateAsync()
    {
        Profile = await RestoreFromStateOrLoad(nameof(Profile), async () =>
        {
            await LoadProfileAndInventory();
            return Profile;
        });
        InventoryTotals = RestoreFromStateOrDefault(nameof(InventoryTotals), InventoryTotals);
        PanelIndex = RestoreFromStateOrDefault(nameof(PanelIndex), PanelIndex);
        LoadingMessage = RestoreFromStateOrDefault(nameof(LoadingMessage), LoadingMessage);
        LoadingError = RestoreFromStateOrDefault(nameof(LoadingError), LoadingError);
    }

    protected override Task OnPersistStateAsync()
    {
        PersistToState(nameof(Profile), Profile);
        PersistToState(nameof(InventoryTotals), InventoryTotals);
        PersistToState(nameof(PanelIndex), PanelIndex);
        PersistToState(nameof(LoadingMessage), LoadingMessage);
        PersistToState(nameof(LoadingError), LoadingError);
        return Task.CompletedTask;
    }

    protected override async Task OnParametersSetAsync()
    {
        // If we have navigated to a different profile, reload the new profile
        if ((Profile != null) &&
            !String.Equals(SteamId, Profile?.SteamId, StringComparison.InvariantCultureIgnoreCase) &&
            !String.Equals(SteamId, Profile?.ProfileId, StringComparison.InvariantCultureIgnoreCase))
        {
            await LoadProfileAndInventory();
        }
    }
    
    private void OnSearch(string text)
    {
        Filter = text;
        StateHasChanged();
    }

    private void OnSelectedPanelChanged(int index)
    {
        var filter = !String.IsNullOrEmpty(Filter) ? $"&filter={Uri.EscapeDataString(Filter)}" : String.Empty;

        PanelIndex = index;
        if (!State.IsPrerendering)
        {
            switch (index)
            {
                case 0: NavigationManager.NavigateTo($"/inventory/{Uri.EscapeDataString(SteamId)}?panel=items{filter}"); break;
                case 1: NavigationManager.NavigateTo($"/inventory/{Uri.EscapeDataString(SteamId)}?panel=collections{filter}"); break;
                case 2: NavigationManager.NavigateTo($"/inventory/{Uri.EscapeDataString(SteamId)}?panel=market{filter}"); break;
                case 3: NavigationManager.NavigateTo($"/inventory/{Uri.EscapeDataString(SteamId)}?panel=investment{filter}"); break;
                case 4: NavigationManager.NavigateTo($"/inventory/{Uri.EscapeDataString(SteamId)}?panel=statistics{filter}"); break;
            }
        }
    }
    
    private async Task OnSynchroniseInventory()
    {
        Profile = null;
        StateHasChanged();
        await LoadProfileAndInventory(force: true);
        StateHasChanged();
    }
    
    private async Task LoadProfileAndInventory(bool force = false)
    {
        try
        {
            Logger.LogTrace($"Loading inventory for '{Uri.EscapeDataString(SteamId)}'...");
            Profile = null;
            InventoryTotals = null;

            LoadingError = null;
            LoadingMessage = "Finding Steam profile...";
            StateHasChanged();
            await LoadProfile();

            LoadingMessage = "Synchronising inventory with Steam...";
            StateHasChanged();
            await SynchroniseInventory(force);

            LoadingMessage = "Calculating inventory value...";
            StateHasChanged();
            await LoadInventoryTotals();
            
            LoadingMessage = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error loading profile inventory '{Uri.EscapeDataString(SteamId)}'");
            LoadingMessage = null;
            LoadingError = ex;
            throw;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadProfile()
    {
        try
        {
            Logger.LogTrace("Fetching inventory profile...");
            Profile = await Http.GetFromJsonWithDefaultsAsync<ProfileDetailedDTO>(
                $"api/profile/{Uri.EscapeDataString(SteamId)}/summary"
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error fetching inventory profile for '{Uri.EscapeDataString(SteamId)}'");
            Profile = null;
            throw;
        }
    }
    
    private async Task SynchroniseInventory(bool force = false)
    {
        try
        {
            Logger.LogTrace("Synchronising inventory items...");
            var response = await Http.PostAsync($"api/profile/{Uri.EscapeDataString(SteamId)}/inventory/sync?force={force}", null);
            if(!response.IsSuccessStatusCode)
            {
                throw new HttpRequestException(await response.Content.ReadAsStringAsync(), null, response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            var httpErrorCode = (ex as HttpRequestException)?.StatusCode;
            if (httpErrorCode == HttpStatusCode.Unauthorized)
            {
                var snackBarMessage = (Profile?.LastUpdatedInventoryOn != null
                    ? $"<strong>This inventory is currently private.</strong><br/>You are viewing an old snapshot from {Profile.LastUpdatedInventoryOn.Value.ToString("g")} as we are unable to show you the latest information at this time. "
                    : $"<strong>This inventory is currently private.</strong><br/>We are unable to show you the contents of this inventory. "
                );

                var thisIsMyInventory = State.Is(Profile?.SteamId);
                if (thisIsMyInventory)
                {
                    snackBarMessage += (
                        $"To resolve this, click the action button to update your Steam inventory privacy settings to 'Public', then refresh this page after a few minutes. "
                    );
                }

                Logger.LogWarning(ex, $"Inventory is currently private for '{Uri.EscapeDataString(SteamId)}', unable to synchronise at this time");
                Snackbar.Add(
				    snackBarMessage,
                    Severity.Warning,
                    options =>
                    {
                        options.Icon = "fas fa-fw fa-eye-slash ma-2";
                        if (thisIsMyInventory)
                        {
                            options.Action = "Privacy Settings";
                            options.Onclick = async (x) =>
                            {
                                ExternalNavigationManager.NavigateToNewTab(
                                    $"https://steamcommunity.com/profiles/{Profile?.SteamId}/edit/settings"
                                );
                            };
                        }
                    }
                );
            }
            else
            {
                Logger.LogError(ex, $"Error synchronising inventory items for '{Uri.EscapeDataString(SteamId)}'");
                throw;
            }
        }
    }

    private async Task LoadInventoryTotals()
    {
        try
        {
            Logger.LogTrace("Fetching inventory totals...");
            InventoryTotals = await Http.GetFromJsonWithDefaultsAsync<ProfileInventoryTotalsDTO>(
                $"api/profile/{Uri.EscapeDataString(SteamId)}/inventory/total"
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error fetching inventory totals for '{Uri.EscapeDataString(SteamId)}'");
            InventoryTotals = null;
            throw;
        }
    }

}
