@inject ILogger<CurrencyPicker> Logger
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AppState State
@inject HttpClient Http

@if (State.Currency != null && Currencies != null)
{
    <div @attributes="AdditionalAttributes">
        <MudMenu StartIcon="fas fa-fw fa-coins" Label="@State.Currency.Name" Size="MudBlazor.Size.Large" Direction="MudBlazor.Direction.Right" 
                 AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" Dense="true" MaxHeight="500" title="Change currency">
            @foreach (var currency in Currencies)
            {
                <MudMenuItem OnClick="@(() => ChangeCurrency(currency))">
                    @currency.Name
                </MudMenuItem>
            }
        </MudMenu>
    </div>
}

@code
{
    private IList<CurrencyDetailedDTO> Currencies { get; set; }
    
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object> AdditionalAttributes { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Currencies = await Http.GetFromJsonWithDefaultsAsync<CurrencyDetailedDTO[]>($"api/currency?detailed=true");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error loading currencies");
            Snackbar.Add($"Unable to load currency list. {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task ChangeCurrency(CurrencyDetailedDTO currency)
    {
        Logger.LogInformation($"Currency was changed to '{currency.Name}'");
        await State.ChangeCurrencyAsync(currency);
        
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true, replace: true);
    }

}
