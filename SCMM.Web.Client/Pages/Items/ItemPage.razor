@page "/item/{Name}"
@page "/items/{Name}"
@page "/skin/{Name}"
@page "/skins/{Name}"
@using SCMM.Web.Client.Shared.Components.Items
@using SCMM.Web.Data.Models.UI.Item
@inject ILogger<ItemPage> Logger
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject AppState State

<PageContainer Title="@(Item != null ? $"Item - {Item.Name}" : Name)">

    @if (Item == null)
    {
        <Loading Message="Loading item..." Size="MudBlazor.Size.Large" Typo="MudBlazor.Typo.h6" />
    } 
    else
    {
        <ItemDescriptionDetails Item="@Item" />
    }
            
</PageContainer>

@code {
    
    [Parameter]
    public string Name { get; set; }
    
    private ItemDetailedDTO Item { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadItem();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // If we have navigated to a different item, reload the new item
        if ((Item != null) && !String.Equals(Name, Item?.Name, StringComparison.InvariantCultureIgnoreCase))
        {
            Item = null;
            StateHasChanged();
            await LoadItem();
            StateHasChanged();
        }
    }
    
    private async Task LoadItem()
    {
        try
        {
            Item = await Http.GetFromJsonWithDefaultsAsync<ItemDetailedDTO>($"/api/item/{Name}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error loading the item details");
            Snackbar.Add($"Unable to load item details. {ex.Message}", MudBlazor.Severity.Error);
        }
    }

}
