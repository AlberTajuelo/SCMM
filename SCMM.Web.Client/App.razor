@inject ILogger<App> Logger
@inject ISnackbar Snackbar
@inject ILocalStorageService LocalStorage
@inject AppState AppState
@inject HttpClient Http

<AppProviders />
<Router AppAssembly="@typeof(Program).Assembly">
    <Found Context="routeData">
        @if (State != null)
        {
            <CascadingValue Value="@routeData">
                <RouteView RouteData="@routeData" DefaultLayout="@typeof(AppLayout)" />
            </CascadingValue>
        }
    </Found>
    <NotFound>
        <LayoutView Layout="@typeof(AppErrorLayout)">
            <Error Title="404" SubTitle="Not Found" />
        </LayoutView>
    </NotFound>
</Router>

@code {

    private AppState State { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!(await AppState.ReadFromStorageAsync(LocalStorage)))
            {
                await AppState.TryGuessLocalityAsync();
                await AppState.WriteToStorageAsync(LocalStorage);
            }
            await AppState.RefreshAsync(Http);

            State = AppState;
            State.Changed += (s, e) => StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialise app state");
            Snackbar.Add($"Unable to load application state. {ex.Message}", MudBlazor.Severity.Error);
        }
    }

}
